<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ZenCards — Confirming…</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body style="font-family:system-ui;background:#0b1220;color:#e5e7eb;padding:24px;">
  <h2>Confirming your email…</h2>
  <p id="msg">One moment.</p>

  <script>
  const SUPABASE_URL = "https://elpfcnnrripftxoqeckv.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVscGZjbm5ycmlwZnR4b3FlY2t2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4NTk5MzQsImV4cCI6MjA4MDQzNTkzNH0.uiLHVcRfMXu0V7QRW41TARMIy-Hbhovc4h9uYFzzGLQ";
  const { createClient } = window.supabase;
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  async function go() {
    const msg = document.getElementById("msg");

    try {
      // Supabase email confirmation typically returns ?code=...
      const code = new URLSearchParams(window.location.search).get("code");

      if (code) {
        msg.textContent = "Confirming…";
        const { error } = await supabase.auth.exchangeCodeForSession(code);
        if (error) {
          console.error("exchangeCodeForSession error:", error);
          msg.textContent = "Could not confirm session. Please try logging in.";
          return;
        }
      }

      // If we successfully exchanged, we should now have a session in this browser
      const { data: sessionData, error: sessionErr } = await supabase.auth.getSession();
      if (sessionErr) {
        console.error("getSession error:", sessionErr);
      }

      const hasSession = !!sessionData?.session;

      // Always send them to app.html with startTrial=1.
      // If session exists, app.html can immediately start checkout.
      // If not, app.html will show login and then on login can start checkout.
      msg.textContent = "Email verified. Sending you to ZenCards…";

      const url = new URL("https://zencardstudy.com/app.html");
      url.searchParams.set("startTrial", "1");

      // If you want to be extra safe, you can add a tiny delay so the session write finishes.
      setTimeout(() => {
        window.location.href = url.toString();
      }, hasSession ? 250 : 50);

    } catch (err) {
      console.error("confirm.html fatal error:", err);
      document.getElementById("msg").textContent =
        "Something went wrong. Please go back and log in.";
    }
  }

  go();
</script>

</body>
</html>
