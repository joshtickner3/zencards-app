<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
  // Only redirect to app.html if running in native app AND user has ACTIVE/TRIALING subscription
  async function redirectToAppIfLoggedIn() {

    function isNativeApp() {
      return (
        window.Capacitor !== undefined ||
        window.cordova !== undefined ||
        window.webkit?.messageHandlers?.bridge !== undefined ||
        navigator.userAgent.includes("Capacitor") ||
        (navigator.userAgent.includes("iPhone") && window.statusbar && window.screen.height < 2000)
      );
    }

    if (!isNativeApp() || window.location.pathname.includes("app.html")) return;

    // Wait for Supabase to load
    if (!window.supabase) {
      await new Promise(r => setTimeout(r, 100));
      if (!window.supabase) return;
    }

    const { createClient } = window.supabase;

    const client = createClient(
      "https://elpfcnnrripftxoqeckv.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVscGZjbm5ycmlwZnR4b3FlY2t2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4NTk5MzQsImV4cCI6MjA4MDQzNTkzNH0.uiLHVcRfMXu0V7QRW41TARMIy-Hbhovc4h9uYFzzGLQ",
      {
        auth: {
          persistSession: true,
          autoRefreshToken: true,
          detectSessionInUrl: true,
          storage: window.localStorage,
          storageKey: "zencards-auth",
        },
      }
    );

    const { data } = await client.auth.getSession();
    const user = data?.session?.user;
    if (!user) return;

    // ✅ subscription check
    const { data: subs, error } = await client
      .from("subscriptions")
      .select("status")
      .eq("user_id", user.id);

    if (error) return;

    const statuses = Array.isArray(subs)
      ? subs.map(r => String(r?.status || "").toLowerCase())
      : [];

    const hasAccess = statuses.some(s => s === "active" || s === "trialing");

    if (hasAccess) {
      window.location.replace("app.html");
    }
  }

  redirectToAppIfLoggedIn();
</script>
  <meta charset="UTF-8" />

<meta
  name="viewport"
  content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=yes, maximum-scale=5.0"
/>
  <title>ZenCards — Hands-Free Flashcards (3-Day Free Trial)</title>
  <script>
    // Prevent double-tap to zoom on iOS
    (function() {
      let lastTouchEnd = 0;
      document.addEventListener('touchend', function(event) {
        const now = Date.now();
        if (now - lastTouchEnd <= 350) {
          event.preventDefault();
        }
        lastTouchEnd = now;
      }, { passive: false });
    })();
  </script>
  <style>

    /* ===== Privacy dropdown ===== */
.privacyDrop{
  background:#020617;
  border:1px solid #111827;
  border-radius:0.9rem;
  padding: 0.25rem;           /* outer padding so summary looks good */
}

.privacyDrop > summary{
  list-style: none;
  cursor: pointer;
  padding: 0.85rem 1rem;
  border-radius: 0.75rem;
  font-weight: 900;
  font-size: 1.15rem;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap: 0.75rem;
  user-select: none;
  outline: none;
}

.privacyDrop > summary::-webkit-details-marker{ display:none; }

.privacyDrop > summary:focus{
  box-shadow: 0 0 0 3px rgba(34,197,94,0.18);
  border: 1px solid rgba(34,197,94,0.35);
}

.privacyDrop .chev{
  width: 12px;
  height: 12px;
  border-right: 2px solid rgba(148,163,184,0.9);
  border-bottom: 2px solid rgba(148,163,184,0.9);
  transform: rotate(45deg);
  transition: transform 0.15s ease;
  flex-shrink: 0;
}

.privacyDrop[open] .chev{
  transform: rotate(-135deg);
}

.privacyDropContent{
  padding: 0 1rem 1rem 1rem;
}

.privacyDropContent p,
.privacyDropContent li{
  color: var(--muted);
}

.privacyDropContent h3{
  margin-top: 1rem;
}

    .brandLogo{
  height: clamp(56px, 7vw, 92px);
  width: auto;
  display:block;
}
/* Focus helper for Go button */
#lpGoBtn:focus{
  outline: 3px solid rgba(34,197,94,0.55);
  outline-offset: 3px;
}
.lpGoPulse{
  animation: lpPulse 0.9s ease-in-out 0s 2;
}
@keyframes lpPulse{
  0% { transform: scale(1); }
  50% { transform: scale(1.03); }
  100% { transform: scale(1); }
}

/* ===== Top-left signed-in box (matches app.html style) ===== */
.signedInBox{
  position: fixed;
  top: 14px;
  left: 14px;
  z-index: 12000;
  background: rgba(2,6,23,0.86);
  border: 1px solid #111827;
  border-radius: 14px;
  padding: 0.75rem 0.85rem;
  box-shadow: var(--shadow);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  min-width: 260px;
  display: none; /* shown only when logged in */
}

.signedInBox .who{
  color: #e5e7eb;
  font-weight: 800;
  font-size: 0.92rem;
  margin-bottom: 0.5rem;
  word-break: break-word;
}

.signedInBox .actions{
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
}


    /* ===== Top-right user counter ===== */
.userCounter{
  position: fixed;
  top: 14px;
  right: 14px;
  z-index: 12000;
  background: rgba(2,6,23,0.86);
  border: 1px solid #111827;
  border-radius: 999px;
  padding: 0.5rem 0.75rem;
  box-shadow: var(--shadow);
  display: flex;
  align-items: center;
  gap: 0.5rem;
  backdrop-filter: blur(8px);
}

.userCounter .dot{
  width: 9px;
  height: 9px;
  border-radius: 999px;
  background: rgba(16,185,129,0.75);
  box-shadow: 0 0 0 3px rgba(16,185,129,0.14);
}

.userCounter .label{
  font-size: 0.82rem;
  color: var(--muted);
  white-space: nowrap;
}

.userCounter .num{
  font-size: 0.95rem;
  font-weight: 900;
  color: #e5e7eb;
  letter-spacing: 0.02em;
  white-space: nowrap;
}

/* On small screens, don’t cover content */
@media (max-width: 520px){
  .userCounter{
    top: 10px;
    right: 10px;
    transform: scale(0.95);
    transform-origin: top right;
  }
}

    #billingModal { z-index: 10000; }
    :root{
  /* Backgrounds (deep slate blue = trust/premium) */
  --bg1:#0f172a;            /* deep slate */
  --bg2:#020617;            /* near-black blue */

  /* Surfaces */
  --card: rgba(15,23,42,0.92);
  --border:#1e293b;

  /* Text */
  --text:#e5e7eb;
  --muted:#94a3b8;

  /* CTA (Green) */
  --green:#22c55e;          /* emerald */
  --green2:#16a34a;         /* hover emerald */

  /* Secondary button */
  --slate:#334155;

  /* NEW: Amber for badges */
  --amber:#f59e0b;
  --amber2:#d97706;

  /* NEW: Soft blue for links */
  --link:#60a5fa;
  --link2:#93c5fd;

  --shadow: 0 18px 35px rgba(0,0,0,0.55), 0 0 0 1px rgba(15,23,42,0.7);
}

    *{box-sizing:border-box}
    body{
      margin:0;
      padding:1rem;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: radial-gradient(circle at top, var(--bg1) 0, var(--bg2) 55%);
      color:var(--text);
      line-height:1.5;
    }
  a{
  color: var(--link);
  text-decoration: underline;
  text-underline-offset: 2px;
}
a:hover{
  color: var(--link2);
}

    .container{max-width:980px;margin:0 auto;}
    .card{
      background: var(--card);
      border-radius: 0.9rem;
      padding: 1rem;
      margin-top: 1rem;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
    }
    .row{
      display:flex;
      gap:1rem;
      flex-wrap:wrap;
      align-items:center;
    }
    .row > *{flex:1;min-width:260px}
    /* ===== Header logo blend panel (matches app.html look) ===== */
.appHeader{
  display:flex;
  align-items:center;
  justify-content:center;
  margin-top: 0.25rem;
  margin-bottom: 0.25rem;

  padding: 10px 12px;
  border-radius: 16px;

  /* "blend layer" behind the logo */
  background:
    radial-gradient(circle at 50% 20%, rgba(148,163,184,0.14), rgba(2,6,23,0) 60%),
    linear-gradient(90deg, rgba(2,6,23,0.0), rgba(15,23,42,0.55), rgba(2,6,23,0.0));

  border: 1px solid rgba(30,41,59,0.6);
  box-shadow: 0 18px 35px rgba(0,0,0,0.35);

  width: fit-content;
  margin-left:auto;
  margin-right:auto;

  backdrop-filter: blur(6px);
  -webkit-backdrop-filter: blur(6px);
}
    .logoMark{
      width: 34px;
      height: 34px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.9);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 0.95rem;
      font-weight: 800;
      letter-spacing: 0.06em;
      background: radial-gradient(circle at 30% 0%, var(--green2) 0, #22c55e22 45%, #020617 70%);
      box-shadow: 0 8px 18px rgba(15,23,42,0.9);
      color: var(--text);
      flex-shrink:0;
    }
    h1,h2,h3{margin:0.5rem 0}
    .subtitle{
      text-align:center;
      font-size:0.95rem;
      color:var(--muted);
      margin:0 0 0.75rem 0;
    }
    .hero{
      padding:1.25rem 1rem;
    }
    .hero h1{
      font-size:2rem;
      letter-spacing:0.02em;
      margin:0.25rem 0 0.5rem 0;
    }
    .hero p{
      color:var(--muted);
      margin:0.5rem 0;
      font-size:1.02rem;
    }
    .badge{
  display:inline-block;
  padding:0.2rem 0.55rem;
  border-radius:999px;
  background: rgba(245,158,11,0.16);      /* amber tint */
  font-size:0.78rem;
  color: #fde68a;                         /* light amber text */
  border: 1px solid rgba(245,158,11,0.35);
  margin-right:0.5rem;
  font-weight: 800;
}
    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:0.45rem;
      padding:0.55rem 1.2rem;
      border-radius:999px;
      border:none;
      cursor:pointer;
      background: #0ea5e9;
      color: #020617;
      font-weight:700;
      font-size:0.98rem;
      text-decoration:none;
      box-shadow: 0 8px 18px rgba(16,185,129,0.28);
      transition: background 0.15s ease, transform 0.08s ease, box-shadow 0.12s ease;
      white-space:nowrap;
    }
    .btn:hover{background:var(--green2); transform:translateY(-1px); box-shadow:0 10px 22px rgba(34,197,94,0.35);}
      .btn:hover{background:#0284c7; transform:translateY(-1px); box-shadow:0 10px 22px rgba(14,165,233,0.35);}
    .btn:active{transform:translateY(0); box-shadow:0 4px 10px rgba(15,23,42,0.6);}
    .btn.secondary{
      background: var(--slate);
      color: var(--text);
      box-shadow:none;
    }
   .btn.secondary:hover{
  background:#475569; 
  box-shadow:0 6px 14px rgba(15,23,42,0.65);
}
    .btn.small{padding:0.35rem 0.85rem; font-size:0.85rem}
    /* Make the Start Free Trial button feel more “primary” */
#startTrialTopBtn{
  font-weight: 900;
  letter-spacing: 0.01em;
}

    .muted{color:var(--muted)}
    .grid3{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:0.75rem;
    }
    @media (max-width: 860px){
      .grid3{grid-template-columns:1fr}
    }
    .feature{
      border:1px solid #111827;
      border-radius:0.85rem;
      padding:0.85rem;
      background:#020617;
    }
    .feature h3{margin:0 0 0.35rem 0; font-size:1rem;}
    .feature p{margin:0; color:var(--muted); font-size:0.92rem;}
    .pricing{
      display:flex;
      gap:1rem;
      flex-wrap:wrap;
      align-items:stretch;
    }
    .pricing > *{flex:1; min-width:300px;}
    .priceCard{
      background:#020617;
      border:1px solid #111827;
      border-radius:0.9rem;
      padding:1rem;
    }
    .price{
      font-size:2rem;
      font-weight:900;
      margin:0.25rem 0;
    }
    ul{margin:0.5rem 0 0 1.15rem; color:var(--muted);}
    li{margin:0.35rem 0;}
    .fineprint{
      font-size:0.85rem;
      color:var(--muted);
      margin-top:0.75rem;
      border-top:1px solid #111827;
      padding-top:0.75rem;
    }
    /* ===== Student pain strip (goes above KPI row) ===== */
.painStrip{
  margin-top: 0.9rem;
  margin-bottom: 0.75rem;
  padding: 0.85rem;
  border-radius: 0.95rem;
  background: linear-gradient(180deg, rgba(2,6,23,0.85), rgba(2,6,23,0.65));
  border: 1px solid #111827;
}

.painTitle{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap: 0.75rem;
  margin: 0 0 0.65rem 0;
}

.painTitle h3{
  margin:0;
  font-size: 1.05rem;
}

.painTitle .muted{
  font-size: 0.9rem;
}

.painGrid{
  display:grid;
  grid-template-columns: repeat(3, minmax(0, 1fr));
  gap: 0.75rem;
}

@media (max-width: 860px){
  .painGrid{ grid-template-columns: 1fr; }
}

.painItem{
  background:#020617;
  border:1px solid #111827;
  border-radius:0.85rem;
  padding:0.85rem;
}

.painItemTop{
  display:flex;
  align-items:center;
  gap:0.55rem;
  margin-bottom: 0.25rem;
}

.painIcon{
  width: 34px;
  height: 34px;
  border-radius: 999px;
  display:flex;
  align-items:center;
  justify-content:center;
  border:1px solid #1f2937;
  background: rgba(16,185,129,0.10);
  color: #bbf7d0;
  font-weight: 900;
  flex-shrink: 0;
}

.painItem h4{
  margin:0;
  font-size: 0.98rem;
}

.painItem p{
  margin:0.2rem 0 0 0;
  color: var(--muted);
  font-size: 0.92rem;
}

    .kpiRow{
      display:flex;
      gap:0.75rem;
      flex-wrap:wrap;
      margin-top:0.75rem;
    }
    .kpi{
      flex:1;
      min-width:210px;
      background:#020617;
      border:1px solid #111827;
      border-radius:0.85rem;
      padding:0.85rem;
    }
    .kpi .big{font-size:1.35rem; font-weight:900; margin:0;}
    .kpi .small{margin:0.2rem 0 0 0; color:var(--muted); font-size:0.9rem;}
    .faq details{
      background:#020617;
      border:1px solid #111827;
      border-radius:0.85rem;
      padding:0.85rem;
      margin-top:0.6rem;
    }
    .faq summary{
      cursor:pointer;
      font-weight:700;
    }
    .footer{
      text-align:center;
      color:var(--muted);
      font-size:0.85rem;
      margin:1.25rem 0 0.5rem 0;
    }
    /* ===== Privacy section ===== */
.privacyCard{
  background:#020617;
  border:1px solid #111827;
  border-radius:0.9rem;
  padding:1rem;
}

.privacyCard h2{
  margin-top:0;
}

.privacyCard p{
  margin:0.5rem 0;
  color: var(--muted);
}

.privacyCard ul{
  margin:0.5rem 0 0 1.15rem;
  color: var(--muted);
}

    .note{
      background: rgba(34,197,94,0.10);
      border: 1px solid rgba(34,197,94,0.25);
      color: #d1fae5;
      border-radius: 0.85rem;
      padding: 0.85rem;
    }
    code.inline{
      background:#111827;
      padding:0.15rem 0.4rem;
      border-radius:0.4rem;
      border:1px solid #0b1220;
      color:#cbd5e1;
      font-size:0.9em;
    }
    /* ===== When to use ZenCards (under painStrip) ===== */
.useStrip{
  margin-top: 0.75rem;
  margin-bottom: 0.75rem;
  padding: 0.85rem;
  border-radius: 0.95rem;
  background: linear-gradient(180deg, rgba(2,6,23,0.82), rgba(2,6,23,0.60));
  border: 1px solid #111827;
}

.useTitle{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap: 0.75rem;
  margin: 0 0 0.65rem 0;
}

.useTitle h3{
  margin:0;
  font-size: 1.05rem;
}

.useTitle p{
  margin:0.15rem 0 0 0;
  color: var(--muted);
  font-size: 0.92rem;
}

.pillRow{
  display:flex;
  flex-wrap:wrap;
  gap:0.5rem;
}

.pill{
  display:inline-flex;
  align-items:center;
  gap:0.45rem;
  padding:0.38rem 0.65rem;
  border-radius:999px;
  border:1px solid #1f2937;
  background:#020617;
  color:#cbd5e1;
  font-size:0.88rem;
  white-space:nowrap;
}

.pill .dot{
  width: 8px;
  height: 8px;
  border-radius: 999px;
  background: rgba(16,185,129,0.65);
  box-shadow: 0 0 0 3px rgba(16,185,129,0.10);
}


    /* ===== Login Modal ===== */
    .modalOverlay{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,0.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 1rem;
      z-index: 9999;
    }
    .modalOverlay.show{display:flex;}
    .modal{
      width: 100%;
      max-width: 440px;
      background: #020617;
      border: 1px solid #111827;
      border-radius: 1rem;
      box-shadow: var(--shadow);
      padding: 1rem;
    }
    .modalHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 0.75rem;
    }
    .modalHeader h3{margin:0.25rem 0;}
    .modalClose{
      background: transparent;
      border: 1px solid #1f2937;
      color: var(--text);
      border-radius: 999px;
      padding: 0.25rem 0.6rem;
      cursor:pointer;
    }
    .field{
      display:flex;
      flex-direction:column;
      gap:0.35rem;
      margin-top: 0.75rem;
    }
    .input{
      width: 100%;
      padding: 0.65rem 0.75rem;
      border-radius: 0.75rem;
      border: 1px solid #1f2937;
      background: #0b1220;
      color: var(--text);
      outline: none;
    }
    .input:focus{
      border-color: rgba(34,197,94,0.55);
      box-shadow: 0 0 0 3px rgba(34,197,94,0.12);
    }
    .modalActions{
      display:flex;
      gap:0.75rem;
      align-items:center;
      margin-top: 1rem;
    }
    /* Prevent iOS zoom on input focus */
    .modal input, .modal select, .modal textarea {
      font-size: 16px !important;
    }
    .modalMsg{
      margin-top: 0.75rem;
      color: var(--muted);
      font-size: 0.9rem;
      word-break: break-word;
    }
    .modalMsg.error{color:#fecaca;}
    .modalMsg.ok{color:#bbf7d0;}
    .smallLink{
      color: #cbd5e1;
      font-size: 0.9rem;
      text-decoration: underline;
      background: transparent;
      border: none;
      cursor: pointer;
      padding: 0;
    }
    /* ===== Terms of Service Modal ===== */
.legalLink{
  color:#cbd5e1;
  text-decoration: underline;
  cursor:pointer;
}
.legalModalBody{
  margin-top: 0.75rem;
  max-height: 55vh;
  overflow: auto;
  border: 1px solid #111827;
  border-radius: 0.85rem;
  padding: 0.85rem;
  background: #0b1220;
  color: var(--text);
}

.legalModalBody h4{
  margin: 0 0 0.5rem 0;
}

.legalModalBody p,
.legalModalBody li{
  color: var(--muted);
  font-size: 0.92rem;
}

.legalModalBody ul{
  margin: 0.5rem 0 0 1.15rem;
}

/* ===== iOS app portrait safe-area fix (website unchanged) ===== */
.nativeApp .userCounter{
  top: calc(env(safe-area-inset-top, 0px) + 10px) !important;
}

.nativeApp .signedInBox{
  top: calc(env(safe-area-inset-top, 0px) + 10px) !important;
}

/* Optional: give the whole page breathing room in-app */
.nativeApp body{
  padding-top: env(safe-area-inset-top, 0px);
}
/* ===== App-only: reduce "cramped" feel on small portrait screens ===== */
@media (max-width: 430px){
  .nativeApp .userCounter{
    padding: 0.42rem 0.6rem;
    border-radius: 14px;              /* less huge pill */
    max-width: calc(100vw - 28px);
    gap: 0.45rem;
  }

  .nativeApp .userCounter .label{
    display: none;                    /* keep it clean on portrait */
  }

  .nativeApp .userCounter .num{
    font-size: 0.92rem;
  }

  .nativeApp .signedInBox{
    min-width: 0;                     /* stop forcing 260px */
    max-width: calc(100vw - 28px);
    padding: 0.65rem 0.75rem;
  }

  .nativeApp .signedInBox .who{
    font-size: 0.88rem;
    margin-bottom: 0.45rem;
  }

  .nativeApp .signedInBox .actions{
    gap: 0.4rem;
  }

  .nativeApp .signedInBox .btn.small,
  .nativeApp .signedInBox .btn.secondary.small{
    padding: 0.32rem 0.7rem;
    font-size: 0.82rem;
  }
}
/* ===== Loading Overlay ===== */
.loadingOverlay{
  position: fixed;
  inset: 0;
  z-index: 40000; /* higher than all your modals */
  background: rgba(2,6,23,0.72);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  display: none;
  align-items: center;
  justify-content: center;
  padding: 18px;
}

.loadingOverlay.show{ display:flex; }

.loadingCard{
  width: min(420px, 92vw);
  background: rgba(15,23,42,0.92);
  border: 1px solid rgba(30,41,59,0.8);
  border-radius: 18px;
  box-shadow: var(--shadow);
  padding: 16px 16px;
  text-align: center;
}

.loadingRow{
  display:flex;
  align-items:center;
  justify-content:center;
  gap: 12px;
}

.spinner{
  width: 22px;
  height: 22px;
  border-radius: 999px;
  border: 3px solid rgba(148,163,184,0.35);
  border-top-color: rgba(34,197,94,0.95);
  animation: spin 0.75s linear infinite;
  flex-shrink: 0;
}

@keyframes spin { to { transform: rotate(360deg); } }

.loadingTitle{
  font-weight: 900;
  color: var(--text);
  letter-spacing: 0.01em;
  margin: 0;
  font-size: 1.02rem;
}

.loadingSub{
  margin: 10px 0 0 0;
  color: var(--muted);
  font-size: 0.92rem;
  line-height: 1.35;
}

  </style>
</head>

<body>
  <!-- ===== Loading Overlay ===== -->
  <div class="loadingOverlay" id="loadingOverlay" aria-hidden="true">
    <div class="loadingCard" role="status" aria-live="polite">
      <div class="loadingRow">
        <div class="spinner" aria-hidden="true"></div>
        <p class="loadingTitle" id="loadingTitle">Loading…</p>
      </div>
      <p class="loadingSub" id="loadingSub">Just a moment.</p>
    </div>
  </div>

  <div class="container">
    <div class="appHeader">
      <img class="brandLogo" src="zencards-logo.png" alt="ZenCards" />
    </div>

    <div class="card hero" style="text-align:center;">
      <h1 style="margin-top:0.25rem;">Sign in to access your decks and begin studying</h1>
      <p class="muted" style="max-width:46ch;margin:0.5rem auto 0.75rem auto;">
      </p>

      <div class="row" style="justify-content:center; margin-top:0.5rem;">
        <button class="btn" id="loginBtn" type="button" style="max-width:360px;">
          Log in
        </button>
      </div>

      <div class="row" style="justify-content:center; margin-top:0.75rem;">
  <button class="btn" id="startTrialBtn" type="button" style="max-width:360px;">
    Start 3-Day Free Trial
  </button>
</div>

<p class="muted" id="trialPriceLine" style="font-size:0.92rem; margin-top:0.6rem;">
  Loading price…
</p>

<div class="row" style="justify-content:center; margin-top:0.5rem;">
  <button class="btn secondary small" id="restoreBtn" type="button">
    Restore Purchase
  </button>
</div>

<div class="row" style="justify-content:center; margin-top:0.5rem;">
  <button class="btn secondary small" id="manageSubBtn" type="button">
    Manage Subscription
  </button>
</div>

      <p class="muted" style="font-size:0.9rem; margin-top:0.85rem;">
      </p>
    </div>

    <section id="privacy-data-use" style="margin-top: 2em;">
  <div style="max-width: 600px; margin: 0 auto;">

    <details class="privacyDrop">
      <summary>
        <span>Privacy &amp; Data Use</span>
        <span class="chev" aria-hidden="true"></span>
      </summary>

      <div class="privacyDropContent">
        <p>
          <strong>Your privacy matters to us.</strong>
          ZenCards is designed to help you study more efficiently — not to collect or exploit your personal data.
        </p>

        <h3>What we <u>do not</u> access or store</h3>
        <ul>
          <li>
            We <strong>do not have access to your password</strong>. Passwords are securely handled and hashed by our authentication provider.
          </li>
          <li>
            We <strong>do not read or monitor the content of your decks or flashcards</strong>. Your study materials belong to you.
          </li>
          <li>
            We <strong>do not sell, rent, or share your personal data</strong> with third parties for advertising or marketing purposes.
          </li>
        </ul>

        <h3>Email</h3>
        <p>
          We send emails only for essential account-related purposes (verification, password resets, and account notifications).
          We do not send marketing emails without your consent.
        </p>

        <h3>Questions</h3>
        <p>
          If you have any privacy questions, contact us at
          <a href="mailto:support@zencardstudy.com">support@zencardstudy.com</a>
          and we will answer promptly.
        </p>
      </div>
    </details>

  </div>
</section>




    <p class="footer">
      © <span id="year"></span> ZenCards
      <span class="muted"> • </span>
      <span class="legalLink" id="openTermsLink">Terms of Service</span>
    </p>
  </div>

  <!-- ===== Login Modal ===== -->
  <div class="modalOverlay" id="loginModal">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="loginTitle">
      <div class="modalHeader">
        <div>
          <h3 id="loginTitle">Log in</h3>
          <div class="muted" style="font-size:0.9rem;">Enter your ZenCards email + password.</div>
        </div>
        <button class="modalClose" id="loginCloseBtn" type="button">✕</button>
      </div>

      <div class="field">
        <label class="muted" for="loginEmail">Email</label>
        <input
          class="input"
          id="loginEmail"
          type="email"
          inputmode="email"
          autocomplete="username email"
          autocapitalize="none"
          spellcheck="false"
          placeholder="you@example.com"
        />
      </div>

      <div class="field">
        <label class="muted" for="loginPassword">Password</label>
        <input
          class="input"
          id="loginPassword"
          type="password"
          autocomplete="current-password"
          autocapitalize="none"
          spellcheck="false"
          placeholder="Your password"
        />
      </div>

      <div class="modalActions">
        <button class="btn" id="loginSubmitBtn" type="button">Log in</button>
        <button class="btn secondary" id="loginCancelBtn" type="button">Cancel</button>
      </div>

      <div class="modalMsg" id="loginMsg"></div>

      <div style="margin-top:0.75rem; display:flex; justify-content:space-between; gap:12px;">
        <button class="smallLink" id="forgotPwBtn" type="button">Forgot password?</button>
        <button class="smallLink" id="toggleAuthModeBtn" type="button">Create account</button>
      </div>
    </div>
  </div>

  <!-- ===== Terms of Service Modal ===== -->
  <div class="modalOverlay" id="termsModal">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="termsTitle">
      <div class="modalHeader">
        <div>
          <h3 id="termsTitle">ZenCards Terms of Service</h3>
          <div class="muted" style="font-size:0.9rem;">Last updated: January 2026</div>
        </div>
        <button class="modalClose" id="termsCloseBtn" type="button">✕</button>
      </div>

      <div class="legalModalBody">
        <p class="muted">
          By using ZenCards (“the Service”), you agree to these Terms. If you do not agree, do not use ZenCards.
        </p>

        <h4>1) What ZenCards is</h4>
        <p class="muted">
          ZenCards is a study tool that helps users review flashcards using hands-free audio and silent study modes.
        </p>

        <h4>2) Acceptable use</h4>
        <p class="muted">
          You agree not to share your account, bypass subscriptions or limits, reverse engineer, copy, resell, or use ZenCards for unlawful purposes.
        </p>

        <h4>3) Your content</h4>
        <p class="muted">
          You own the flashcards and study content you create. You grant us permission to store and process it only to provide the Service.
        </p>

        <h4>4) Availability & changes</h4>
        <p class="muted">
          We may update, modify, or discontinue parts of ZenCards at any time. We do not guarantee uninterrupted service.
        </p>

        <h4>5) Disclaimer</h4>
        <p class="muted">
          ZenCards is provided “as is.” We do not guarantee academic outcomes.
        </p>

        <h4>6) Limitation of liability</h4>
        <p class="muted">
          To the maximum extent permitted by law, ZenCards is not liable for indirect or incidental damages arising from your use of the Service.
        </p>

        <h4>7) Termination</h4>
        <p class="muted">
          We may suspend or terminate accounts that violate these Terms, including account sharing by groups or institutions.
        </p>

        <h4>8) Contact</h4>
        <p class="muted">
          Questions? Email <strong>support@zencardstudy.com</strong>
        </p>
      </div>

      <div class="modalActions" style="margin-top: 1rem;">
        <button class="btn secondary" id="termsOkBtn" type="button">Close</button>
      </div>
    </div>
  </div>
  <script>
  // Footer year
  document.getElementById("year").textContent = String(new Date().getFullYear());

  // Supabase
  const SUPABASE_URL = "https://elpfcnnrripftxoqeckv.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVscGZjbm5ycmlwZnR4b3FlY2t2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4NTk5MzQsImV4cCI6MjA4MDQzNTkzNH0.uiLHVcRfMXu0V7QRW41TARMIy-Hbhovc4h9uYFzzGLQ";
  const AUTH_KEY = "zencards-auth";

  const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    auth: {
      persistSession: true,
      autoRefreshToken: true,
      detectSessionInUrl: true,
      storage: window.localStorage,
      storageKey: AUTH_KEY,
    },
  });

  // ✅ Handle email confirmation deep links like: zencards://auth-callback?code=...&next=startTrial
async function handleDeepLink(url) {
  try {
    if (!url) return;

    const u = new URL(url);
    const next = u.searchParams.get("next");

    const code = u.searchParams.get("code");
    const access_token = u.searchParams.get("access_token");
    const refresh_token = u.searchParams.get("refresh_token");

    if (code) {
      const { error } = await supabaseClient.auth.exchangeCodeForSession(code);
      if (error) throw error;
    } else if (access_token) {
      const { error } = await supabaseClient.auth.setSession({
        access_token,
        refresh_token: refresh_token || "",
      });
      if (error) throw error;
    }

    if (next === "startTrial") {
      await startTrialFlow(); // your Apple IAP flow
    }
  } catch (e) {
    console.error("Deep link auth failed:", e);
    alert(e?.message || "Could not complete email confirmation.");
  }
}

if (window.Capacitor?.Plugins?.App?.addListener) {
  window.Capacitor.Plugins.App.addListener("appUrlOpen", async (event) => {
    await handleDeepLink(event?.url);
  });
}


  // --- IAP / Trial wiring (native-only) ---
const PRODUCT_ID = "com.zencards.pro.monthly";

function isNativeApp() {
  return (
    window.Capacitor !== undefined ||
    navigator.userAgent.includes("Capacitor") ||
    window.webkit?.messageHandlers?.bridge !== undefined
  );
}

async function loadPriceLine() {
  const line = document.getElementById("trialPriceLine");
  if (!line) return;

  if (!isNativeApp() || !window.Capacitor?.Plugins?.IAPPlugin) {
    line.textContent = "Subscriptions available in the iOS app.";
    return;
  }

  try {
const res = await window.Capacitor.Plugins.IAPPlugin.getProducts({
  productIdentifiers: [PRODUCT_ID],
});
console.log("getProducts res:", res);

const p =
  res?.products?.find(x => (x.id || x.productId) === PRODUCT_ID) ||
  res?.products?.[0];
    line.textContent = p
      ? `3 days free, then ${p.displayPrice} / month`
      : "3 days free, then monthly (price loads after Apple approves the product)";
  } catch (e) {
    console.error(e);
    line.textContent = "3 days free, then monthly";
  }
}

async function getUserOrNull() {
  const { data } = await supabaseClient.auth.getSession();
  return data?.session?.user || null;
}

async function verifyWithServer({ userId, productId, transactionId, receipt }) {
  const url = `${SUPABASE_URL}/functions/v1/verify-ios-subscription`;

  // Use the logged-in user's JWT so the function can trust who is calling
  const { data } = await supabaseClient.auth.getSession();
  const accessToken = data?.session?.access_token;
  if (!accessToken) throw new Error("Missing session token. Please log in again.");

  // ✅ Build payload OUTSIDE fetch options
  const payload = {
    user_id: userId,
    product_id: productId,
    transaction_id: transactionId,
    receipt, // may be undefined/null sometimes; that's OK if your function handles it
  };

  console.log("verify payload:", { ...payload, hasReceipt: !!payload.receipt });

  const res = await fetch(url, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": `Bearer ${accessToken}`,
    },
    body: JSON.stringify(payload),
  });

  const json = await res.json().catch(() => ({}));
  if (!res.ok) {
    throw new Error(json?.error || "Subscription verification failed.");
  }

  return json;
}

async function startTrialFlow() {
  const btn = document.getElementById("startTrialBtn");
  const line = document.getElementById("trialPriceLine");

  if (!isNativeApp()) {
    alert("Start your free trial from the iOS app.");
    return;
  }

  if (!window.Capacitor?.Plugins?.IAPPlugin) {
    alert("In-app purchases not available yet (plugin not loaded).");
    return;
  }

  btn.disabled = true;
  const oldText = btn.textContent;
  btn.textContent = "Starting…";
  if (line) line.textContent = "Contacting Apple…";

  try {
    const existingUser = await getUserOrNull();

    if (!existingUser) {
      pendingAfterAuth = startTrialFlow;
      openLoginModal("signup");

      // reset UI before returning
      btn.disabled = false;
      btn.textContent = oldText;
      if (line) line.textContent = "Create an account to start your free trial.";
      return;
    }

    const user = existingUser;

    const purchaseRes = await window.Capacitor.Plugins.IAPPlugin.purchase({
      productId: PRODUCT_ID,
    });

    if (purchaseRes?.status === "cancelled") {
      if (line) await loadPriceLine(); // puts the real price back
      return;
    }

    if (purchaseRes?.status !== "success") {
      throw new Error("Purchase did not complete.");
    }

    // ✅ IMPORTANT: make sure transactionId exists
    const txId = purchaseRes?.transactionId;
    if (!txId) throw new Error("Missing transactionId from IAP plugin.");

  console.log("purchaseRes:", purchaseRes);

// Try to extract a receipt / signed transaction from whatever the plugin returns
const receipt =
  purchaseRes?.receipt ||
  purchaseRes?.transactionReceipt ||
  purchaseRes?.signedTransactionInfo ||
  purchaseRes?.transaction?.signedTransactionInfo ||
  null;

await verifyWithServer({
  userId: user.id,
  productId: purchaseRes.productId,
  transactionId: txId,
  receipt,
});

    window.location.replace("app.html");
  } catch (e) {
    console.error(e);
    alert(e?.message || "Could not start trial.");
    if (line) line.textContent = "3 days free, then monthly";
  } finally {
    btn.disabled = false;
    btn.textContent = oldText;
  }
}

async function restoreFlow() {
  try {
let user = await getUserOrNull();

if (!user) {
  pendingAfterAuth = restoreFlow;
  openLoginModal("login");
  return;
}

    const ent = await window.Capacitor.Plugins.IAPPlugin.getEntitlements();
    const active = ent?.activeProductIds || [];

    if (!active.includes(PRODUCT_ID)) {
      alert("No active subscription found to restore.");
      return;
    }

    // Try to pull a receipt / signed transaction from entitlements if available
    const receipt =
      ent?.receipt ||
      ent?.transactionReceipt ||
      ent?.signedTransactionInfo ||
      null;

    // ✅ Call your Edge Function to verify + update subscriptions server-side
    await verifyWithServer({
      userId: user.id,
      productId: PRODUCT_ID,
      transactionId: null,
      receipt,
    });

    window.location.replace("app.html");
  } catch (e) {
    console.error(e);
    alert(e?.message || "Restore failed.");
  }
}

async function openManageSubscription() {
  // If not native (web browser), send to Apple account subscriptions page (or your own web billing page)
  if (!isNativeApp()) {
    window.location.href = "https://apps.apple.com/account/subscriptions";
    return;
  }

  // If your IAP plugin exposes a native “manage subscriptions” method, use it
  try {
    if (window.Capacitor?.Plugins?.IAPPlugin?.openManageSubscriptions) {
      await window.Capacitor.Plugins.IAPPlugin.openManageSubscriptions();
      return;
    }
  } catch (e) {
    console.warn("openManageSubscriptions failed, falling back:", e);
  }

  // Fallback: open Apple's manage subscriptions page
  window.open("https://apps.apple.com/account/subscriptions", "_system");
}

  async function checkUserAccess(uid) {
    const { data, error } = await supabaseClient
      .from("subscriptions")
      .select("status")
      .eq("user_id", uid);

    if (error) return { hasAccess: false, error: error.message };

    const statuses = Array.isArray(data)
      ? data.map(r => String(r?.status || "").toLowerCase())
      : [];

    return {
      hasAccess: statuses.some(s => s === "active" || s === "trialing"),
      statuses,
    };
  }

  async function setPaywallModeIfNeeded() {
  // Only matters inside the native app
  if (!isNativeApp()) return;

  const { data } = await supabaseClient.auth.getSession();
  const user = data?.session?.user;

  // Not logged in: keep default UI (login CTA)
  if (!user) return;

  // Logged in: check access
  const access = await checkUserAccess(user.id);

  // If they have access, redirect (extra safety)
  if (access.hasAccess) {
    window.location.replace("app.html");
    return;
  }

  // ---- PAYWALL MODE ----
  // Make page clearly tell them they’re signed in but need Pro
  const heroTitle = document.querySelector(".card.hero h1");
  if (heroTitle) heroTitle.textContent = "You’re signed in — start your free trial to unlock ZenCards Pro";

  // Make login button less prominent (optional)
  const loginBtn = document.getElementById("loginBtn");
  if (loginBtn) {
    loginBtn.textContent = "Switch account";
    loginBtn.classList.add("secondary");
  }

  // Show trial UI (it may already be visible in native)
  const startTrialBtn = document.getElementById("startTrialBtn");
  const restoreBtn = document.getElementById("restoreBtn");
  const priceLine = document.getElementById("trialPriceLine");

  if (startTrialBtn) startTrialBtn.style.display = "";
  if (restoreBtn) restoreBtn.style.display = "";
  if (priceLine) priceLine.style.display = "";

  // Show a clear message in the modal msg area (or add a new line under buttons)
  const msg = document.getElementById("trialPriceLine");
  if (msg) {
    // Keep the price line behavior, but you can prepend clarity:
    // (don’t overwrite if loadPriceLine will populate)
  }
}

// Run once on load
setPaywallModeIfNeeded();

  // Modal wiring
  const loginModal = document.getElementById("loginModal");
  const loginBtn = document.getElementById("loginBtn");
  // Show/hide trial UI (only show in native app)
const startTrialBtn = document.getElementById("startTrialBtn");
const restoreBtn = document.getElementById("restoreBtn");

if (!isNativeApp()) {
  if (startTrialBtn) startTrialBtn.style.display = "none";
  if (restoreBtn) restoreBtn.style.display = "none";
  const line = document.getElementById("trialPriceLine");
  if (line) line.style.display = "none";
} else {
  loadPriceLine();
  startTrialBtn?.addEventListener("click", startTrialFlow);
  restoreBtn?.addEventListener("click", restoreFlow);

  // ✅ Manage Subscription button (Apple)
  const manageSubBtn = document.getElementById("manageSubBtn");
  manageSubBtn?.addEventListener("click", openManageSubscription);
}
  const loginCloseBtn = document.getElementById("loginCloseBtn");
  const loginCancelBtn = document.getElementById("loginCancelBtn");
  const loginSubmitBtn = document.getElementById("loginSubmitBtn");
  const loginEmail = document.getElementById("loginEmail");
  const loginPassword = document.getElementById("loginPassword");
  const loginMsg = document.getElementById("loginMsg");
  const forgotPwBtn = document.getElementById("forgotPwBtn");
const toggleAuthModeBtn = document.getElementById("toggleAuthModeBtn");

let AUTH_MODE = "login"; // "login" | "signup"
let pendingAfterAuth = null; // function to run after successful auth

// Toggle between Login and Create Account modes
toggleAuthModeBtn?.addEventListener("click", () => {
  if (AUTH_MODE === "login") setAuthMode("signup");
  else setAuthMode("login");
});

function setAuthMode(mode) {
  AUTH_MODE = mode;

  const title = document.getElementById("loginTitle");
  const submit = document.getElementById("loginSubmitBtn");
  const toggle = document.getElementById("toggleAuthModeBtn");

  if (mode === "signup") {
    if (title) title.textContent = "Create account";
    if (submit) submit.textContent = "Create account";
    if (toggle) toggle.textContent = "Already have an account?";
  } else {
    if (title) title.textContent = "Log in";
    if (submit) submit.textContent = "Log in";
    if (toggle) toggle.textContent = "Create account";
  }
}

  function openLoginModal(mode = "login") {
  setAuthMode(mode);
  loginMsg.textContent = "";
  loginMsg.className = "modalMsg";
  loginModal.classList.add("show");
  setTimeout(() => loginEmail.focus(), 50);
}
  
  function closeLoginModal() {
    loginModal.classList.remove("show");
  }

loginBtn.addEventListener("click", () => openLoginModal("login"));
  loginCloseBtn.addEventListener("click", closeLoginModal);
  loginCancelBtn.addEventListener("click", closeLoginModal);

  loginModal.addEventListener("click", (e) => {
    if (e.target === loginModal) closeLoginModal();
  });

  // ✅ IMPORTANT for Apple: disable account creation in-app
  // (You can remove the button entirely, but this guarantees it can’t be used.)
  // In the iOS app we DO allow account creation (required for trial flow)
if (toggleAuthModeBtn) {
  toggleAuthModeBtn.style.display = "";
}

  // Forgot password is fine
  forgotPwBtn.addEventListener("click", async () => {
    const email = (loginEmail.value || "").trim();
    if (!email) {
      loginMsg.textContent = "Enter your email above first, then tap “Forgot password?”.";
      loginMsg.className = "modalMsg error";
      return;
    }

    const { error } = await supabaseClient.auth.resetPasswordForEmail(email, {
      redirectTo: "https://zencardstudy.com/reset.html",
    });

    if (error) {
      loginMsg.textContent = error.message || "Could not send reset email.";
      loginMsg.className = "modalMsg error";
      return;
    }

    loginMsg.textContent = "Password reset email sent ✅";
    loginMsg.className = "modalMsg ok";
  });

  // Submit login (subscription-gated)
 loginSubmitBtn.addEventListener("click", async () => {
  const email = (loginEmail.value || "").trim();
  const password = loginPassword.value || "";

  if (!email || !password) {
    loginMsg.textContent = "Please enter your email and password.";
    loginMsg.className = "modalMsg error";
    return;
  }

  loginSubmitBtn.disabled = true;
  loginSubmitBtn.textContent = (AUTH_MODE === "signup") ? "Creating…" : "Logging in…";
  loginMsg.textContent = "";
  loginMsg.className = "modalMsg";

  try {
    let res;

    if (AUTH_MODE === "signup") {
      // ✅ App-only signup bypasses email confirmation
    const r = await fetch(`${SUPABASE_URL}/functions/v1/app-signup`, {
  method: "POST",
  headers: {
    "Content-Type": "application/json",
    "apikey": SUPABASE_ANON_KEY,
    "x-app-signup-secret": "zencards_app_signup_9f3c2a0d7b4e4c3a9a8d1f2b6c7d8e9f",
  },
  body: JSON.stringify({ email, password }),
});

      const raw = await r.text();
      let j = {};
      try { j = JSON.parse(raw); } catch {}

      if (!r.ok) {
        console.error("app-signup failed:", r.status, raw);
        throw new Error(j?.error || raw || "Could not create account.");
      }

      // Now log them in immediately (session created in-app)
      res = await supabaseClient.auth.signInWithPassword({ email, password });
    } else {
      res = await supabaseClient.auth.signInWithPassword({ email, password });
    }

    if (res?.error) {
      loginMsg.textContent = res.error.message;
      loginMsg.className = "modalMsg error";
      return;
    }

    // ✅ Ensure we actually have a session + user
    const { data: sessData } = await supabaseClient.auth.getSession();
    const user = sessData?.session?.user;
    if (!user) throw new Error("Login succeeded but no session was created.");

   // ✅ run pending action (startTrialFlow / restoreFlow) if this login/signup was triggered by them
if (typeof pendingAfterAuth === "function") {
  const fn = pendingAfterAuth;
  pendingAfterAuth = null;

  closeLoginModal();   // close only when we’re about to continue elsewhere
  await fn();
  return;
}

    // Otherwise, normal login path: check access
    const access = await checkUserAccess(user.id);

   if (access.hasAccess) {
  closeLoginModal();
  window.location.replace("app.html");
  return;
}

    loginMsg.textContent =
      "No active subscription found. Tap “Start 3-Day Free Trial” to unlock ZenCards Pro.";
    loginMsg.className = "modalMsg error";

    setPaywallModeIfNeeded();
  } catch (e) {
    console.error(e);
    loginMsg.textContent = e?.message || "Login failed. Please try again.";
    loginMsg.className = "modalMsg error";
  } finally {
    loginSubmitBtn.disabled = false;
    loginSubmitBtn.textContent = (AUTH_MODE === "signup") ? "Create account" : "Log in";
  }
});

  // Enter key submits
  [loginEmail, loginPassword].forEach(el => {
    el.addEventListener("keydown", (e) => {
      if (e.key === "Enter") loginSubmitBtn.click();
      if (e.key === "Escape") closeLoginModal();
    });
  });

  // Terms modal
  const termsModal = document.getElementById("termsModal");
  const openTermsLink = document.getElementById("openTermsLink");
  const termsCloseBtn = document.getElementById("termsCloseBtn");
  const termsOkBtn = document.getElementById("termsOkBtn");

  function openTermsModal(){ termsModal.classList.add("show"); }
  function closeTermsModal(){ termsModal.classList.remove("show"); }

  openTermsLink?.addEventListener("click", openTermsModal);
  termsCloseBtn?.addEventListener("click", closeTermsModal);
  termsOkBtn?.addEventListener("click", closeTermsModal);

  termsModal?.addEventListener("click", (e) => {
    if (e.target === termsModal) closeTermsModal();
  });
</script>
<footer style="margin-top: 3rem; text-align: center; font-size: 0.9rem; color: #94a3b8;">
  <a href="./support.html" style="color: inherit; text-decoration: underline;">
    Support
  </a>
</footer>

</body>

</html>